# Домашнее задание №2 Технопарк курс "Проектирование высоконагруженных приложений"
[Общее задание](https://park.mail.ru/blog/topic/view/15123/)


 Выбранная тема - Сервис онлайн прослушивания музыки (like Яндекс.Музыка, BOOM, Spotify)

 -----

1. [Определение возможного диапазона нагрузок проекта](#Определение-возможного-диапазона-нагрузок-проекта)
    * [Оценка аудитории](#Оценка-аудитории)
    * [Оценка нагрузки](#Оценка-нагрузки)
2. [Выбор планируемой нагрузки](#Выбор-планируемой-нагрузки)
3. [Логическая схема базы данных](#Логическая-схема-базы-данных)
4. [Физические системы хранения](#Физические-системы-хранения)
5. [Выбор прочих технологий](#Выбор-прочих-технологий)
6. [Расчет нагрузки и потребного оборудования]()
7. [Выбор хостинга / облачного провайдера и расположения серверов]()
8. [Схема балансировки нагрузки]()
9. [Обеспечение отказоустойчивости]()

## Определение возможного диапазона нагрузок проекта

### Оценка аудитории 
 По данным [Яндекс.Радар](https://radar.yandex.ru/) месячная аудитория Яндекс.Музыки за октябрь составила ~12.5 млн человек, при дневной аудитории в ~2.1 млн человек<sup>[[1]](https://radar.yandex.ru/yandex?month=2020-10)</sup>. Среднее время проведенное пользователем в месяц с учетом кросс-платформенности составляет 7 часов 6 минут.

### Оценка нагрузки

Оценка показателей нагрузки произовдилась на примере [Яндекс.Музыки](https://music.yandex.ru/). Основная нагрузка в сервисе приходится на отправку аудио файлов пользователю. Как среднюю длину одного трека возьмем 4 минуты 10 секунд. *(Данные получены на основе анализа медиатеки автора - плейлист в 1905 треков продолжительностью 132.5 часа)* Размер секунды аудиозаписи при битрейте в 192 Кбит/с составляет 24 Кб. Следовательно средний размер аудиозаписи в стандартном качестве *(в сервисе присутствует воспроизведение музыки в высоком качестве)* в сервисе составляет:

`Размер_трека = (4 мин * 60 с + 10 с) * 24 Кб = 6000 Кб ~= 5.86 Мб`

Объем медиатеки сервиса на момент 27 сентября 2017 года составлял более 35 млн треков <sup>[[2]](https://www.interfax.ru/business/580802)</sup>. Хранение 35 млн треков требует как минимум:

`Минимальный_объем_памяти_медиатеки = 35 * 10^6 треков * 5.86 Мб ~= 205 100 000 Мб ~= 195.6 Тб`

По данным [speedtest.net global index](https://www.speedtest.net/global-index) средняя скорость интернета на загрузку в России для Wi-Fi станций (что можно считать средней скоростью домашнего интернета) составляет 77.51 Мбит/с, для мобильного интернета - 23.22 Мбит/с. Доля мобильной аудитории Яндекс.Музыки согласно данным Яндекс.Радара составляет 39%. Однако мобильными пользователями можно пренебречь, т.к. мобильное приложение позволяет сохранять треки на своем устройстве. В итоге интернет-соединение для мобильного пользователя требуется только для прослушивания не сохраненных треков и для сбора статистики по прослушиванию. Возьмем среднюю скорость загрузки равной 77.51 Мбит/с

По этим данным получаем, что для загрузки 1 трека в Яндекс.Музыке необходимо:

`Время_загрузки = 5.86 Мб / (77.51 Мбит/с / 8 бит) ~= 0.6 сек`

Среднее время прослушивания музыки в день у пользователей Яндекс.Музыки составляет 90 минут<sup>[[3]](https://rg.ru/2020/03/26/kakuiu-muzyku-predpochitaiut-slushat-rossiiane-na-karantine.html)</sup> (5400 секунд). При средней длине трека в 250 секунд, получим среднее количество прослушиваемых треков в день равное 22 трекам. Как было замечено выше у мобильных пользователей потребность в загрузке треков минимальна, поэтому мы можем пренебречь этими данными в следующих расчетах. Тогда дневная аудитория активно нагружающая сервис будет составлять ~1.28 млн человек. Среднее количество запросов в секунду будет составлять: 

`RPS_загрузка_трека = 1.28 * 10^6 чел * 22 трека / (24 ч * 60 мин * 60 с) ~= 326 rps`

При этом размер трафика будет составлять:

`Трафик_загрузки_трека = 1.28 * 10^6 чел * 22 трека * 5.86 Мб * 8 бит / (24 ч * 60 мин * 60 с) ~= 14.92 Гбит/с`

## Выбор планируемой нагрузки

В качестве предполагаемой нагрузки выбрано значение в 30% от общей доли интернет-пользователей в России. Данная аудитория будет считаться как месячное посещение разрабатываемого сервиса. 

По данным проекта [Web-Index](https://webindex.mediascope.net/) сайта [Mediascope](https://mediascope.net/) количество интернет-пользователей старше 12 лет в России составляет ~95.3 млн человек<sup>[[4]](https://webindex.mediascope.net/general-audience)</sup>. Таким образом потенциальная аудитория сервиса должна составить 28.59 млн человек. Основываясь на данных Яндекс.Музыки можем предположить, что суточная аудитория сервиса должна составить 17% от месячной или 4.8 млн человек. 

В расчетах мы не будем делить аудиторию на мобильную и десктопную, предположив использование нашего сервиса на ПК.

Предполагамое среднее количество запросов в секунду должно составить:

`Предполагаемый_RPS_загрузка_трека = 4.8 * 10^6 чел * 22 трека / (24 ч * 60 мин * 60 с) ~= 1222 rps`

Предполагаемый средний трафик в секунду должен составить:

`Предполагаемый_Трафик_загрузки_трека = 4.8 * 10^6 чел * 22 трека * 5.86 Мб * 8 бит / (24 ч * 60 мин * 60 с) ~= 55.94 Гбит/с`

При составленном пользователем заранее плейлисте его основные действия будут состаять в открытии плейлиста и его включении. Данный процесс предположительно требует 4 обращения к API сервиса (загрузка данных пользователя, загрузка плейлистов, загрузка информации плейлиста, загрузка списка треков). Потенциально во время сессии пользователь может захотеть добавить себе несколько треков в аудиотеку. Предположим, что каждый пользователь в течение дня добавляет себе по 4 трека в один из плейлистов. Данный процесс занимает еще предположительно 4 запроса к API(поиск трека/альбома/исполнителя, открытие исполнителя, открытие альбома, добавление трека в плейлист). Исходя из ранее расчитанных данных и полученных выше данных получим среднее количество rps для API:

`API_средний_rps = 4.8 * 10^6 чел * (22+4+4*4) / (24 ч * 60 мин * 60 с) ~= 2400 rps`

Данный показатель в момент пиковой загрузки увеличивать нагрузку на 6 часов (с 18:00 до 24:00) для основной массы пользователей (Европейская часть России - 70% населения). Тогда пиковый rps может достигать:

`API_пиковый_rps = 4.8 * 10^6 чел * 0.7 * (22+4+4*4) / (6 ч * 60 мин * 60 с) ~= 6600 rps`

Пиковый потенциальный трафик:

`Предполагаемый_Пиковый_Трафик_загрузки_трека = 4.8 * 10^6 чел * 0.7 * 22 трека * 5.86 Мб * 8 бит / (6 ч * 60 мин * 60 с) ~= 156.67 Гбит/с`

## Логическая схема базы данных

![Логическая схема базы данных](img/database.png)

Также стоит отметить, что для реализации очереди воспроизведения, ее целесообразно хранить на сервере, что уберет необходимость организации ее хранения на стороне клиента. Так как очередь воспроизведения достаточно динамически изменяющаяся единица, целесообразно вынести ее из общей логики хранения в отдельную структуру.

## Физические системы хранения

Как было обозначено выше для очереди воспроизведения целесообразно выделить отдельный узел, имеющий возможность быстрого обращения. В качестве системы хранения для этого можно использовать Redis. Данная БД хранит данные в оперативной памяти, обладает высокой производительностью на операциях set-get (до 100 тысяч операций в секунду), поддерживает master-slave репликацию. Необходимое значение будет выставляться только при смене трека вне текущего списка воспроизведения, следовательно основной операцией для Redis станет именно get, так как загрузку очереди достаточно выполнить один раз. Также возможна потенциальная выгрузка данных на диск для неактивных пользователей. Для поддержания заявленной нагрузки воспользуемся двумя базами для содержания реплики основной активной базы.

Для хранения основных данных сервиса будем использовать PostgreSQL. Данные о треках, артистах и альбомах не требуют постоянных изменений. Для хранения этой информации, а так же плейлистов пользователей можно воспользоваться одной БД с репликой по приницпу master-slave.

Стоит заметить, что единственной активной единицей в БД является история прослушиваний, обновляемая при каждой загрузке трека. Данную таблицу можно вынести в отдельную базу данных, для дальнейшего использования информации в целях создания рекомендаций, выстраивания статистики и т.д. Для таких целей хорошо подойдет Clickhouse. Данная БД является колоночной, и создана специально для проведения аналитических запросов.

Для хранения музыкальных треков будем использовать CDN, что позволит создать распределенную сеть обладающую надежностью и высокой доступностью данных для пользователя.

## Выбор прочих технологий

Для разработки фронтенда испольузем JavaScript/TypeScript.

В качестве языка написания бекенда выберем Go, так как язык обладает отличной поддержкой многопоточности, обладает высокой производительностью, при этом за счет широкого выбора библиотек для разных целей, позволяет быстро разрабатывать высоконагруженные и легкоподдерживаемые приложения.

Так как разные элементы сервиса оказываются весьма несбалансированно нагружены по обращениям, разработку будем вести на основе микросервисов. В качестве основного протокола будем использовать gRPC.

В качестве веб-сервера выбор был сделан в пользу nginx.